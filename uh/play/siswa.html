<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SDN 1 KANDANGAN KOTA - Ulangan Harian Kelas 6</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
.kop { text-align:center; margin-bottom:25px; border-bottom:3px double #000; padding-bottom:10px;}
.kop img{width:80px;height:80px;margin-bottom:10px;}
.kop h2,h4,p{margin:0;line-height:1.4;}
.question-box{padding:15px;border:1px solid #ddd;border-radius:8px;margin-bottom:15px;background:#fff;}
img{max-width:100%;height:auto;display:block;margin:10px auto;max-height:300px;object-fit:contain;}
</style>
</head>
<body class="bg-light">
<div class="container py-4">

<div class="kop">
  <img src="https://oneon360.github.io/web/uh/logo-sdn1kk-wartatrans.png" alt="Logo Sekolah">
  <h2>SDN 1 KANDANGAN KOTA</h2>
  <p>Jl. Jendral Achmad Yani, Kecamatan Kandangan</p>
  <p>NISN: 30301968</p>
</div>

<div class="text-center">
  <h4>ULANGAN HARIAN KELAS 6</h4>
  <p>Tahun Pelajaran 2025</p>
</div>

<!-- Informasi cara pengerjaan soal -->
<div class="alert alert-warning">
  <h5>üìå Petunjuk Pengerjaan:</h5>
  <ul>
    <li>Pilih nama lengkap sebelum memulai.</li>
    <li>Pilih mata pelajaran yang akan dikerjakan.</li>
    <li>Baca dan pahami soal dengan cermat dan teliti.</li>
    <li>Pilihlah jawaban dengan menekan opsi check box.</li>
    <li>Silahkan bertanya kepada guru, jika soal kurang jelas.</li>
    <li>Kerjakan dengan jujur tanpa bantuan orang lain.</li>
    <li>Setiap mata pelajaran hanya bisa dikerjakan <b>1 kali</b>.</li>
    <li>Jika sudah selesai, hasil langsung tersimpan otomatis.</li>
  </ul>
</div>

<div class="card p-4 shadow">
  <h5>üìù Ulangan Siswa</h5>
  <div class="mb-3">
    <label>Nama Siswa/siswi</label>
    <select id="studentName" class="form-select">
      <option value="">-- Pilih Nama --</option>
    </select>
  </div>
  <div id="confirmBox" class="alert alert-info d-none">
    Apakah benar nama kamu <b><span id="confirmName"></span></b>? 
    <button class="btn btn-success btn-sm" onclick="confirmYes()">Ya</button>
    <button class="btn btn-danger btn-sm" onclick="confirmNo()">Tidak</button>
  </div>
  <div class="mb-3">
    <label>Mata Pelajaran</label>
    <select id="subjectSelect" class="form-select">
      <option value="">-- Pilih Pelajaran --</option>
      <option>Pendidikan Pancasila</option>
      <option>Bahasa Indonesia</option>
      <option>Matematika</option>
      <option>IPAS</option>
      <option>Seni Rupa</option>
    </select>
  </div>
  <button class="btn btn-primary mb-3" onclick="loadQuestions()">Mulai</button>

  <form id="quizForm" class="d-none">
    <div id="questionContainer"></div>
    <button type="button" class="btn btn-success mt-3" onclick="submitAnswers()">Kumpulkan Jawaban</button>
  </form>

  <div id="result" class="alert alert-info mt-3 d-none"></div>
</div>
</div>

<script>
let soal = {};
let currentName = "";
const soalURL = "https://oneon360.github.io/web/uh/soal.json";
const siswaURL = "https://oneon360.github.io/web/uh/play/nama.json";
// Ganti dengan URL Web App Anda
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby52Cz1GFVAlQOH0PsTGaK09eCrv1dS8kkxdWaQD9F2kdDwTUNuLfrePEeybXp55gef/exec";

// Ambil daftar siswa
async function fetchSiswa(){
  try{
    const res = await fetch(siswaURL);
    const data = await res.json();
    let sel = document.getElementById("studentName");
    data.forEach(s=>{
      let opt = document.createElement("option");
      opt.value = s.nama;
      opt.textContent = s.nama;
      sel.appendChild(opt);
    });
  }catch(e){ console.error(e); }
}
fetchSiswa();

// Saat pilih nama
document.getElementById("studentName").addEventListener("change", ()=>{
  const val = document.getElementById("studentName").value;
  if(val){
    document.getElementById("confirmName").innerText = val;
    document.getElementById("confirmBox").classList.remove("d-none");
  }else{
    document.getElementById("confirmBox").classList.add("d-none");
  }
});

function confirmYes(){
  currentName = document.getElementById("studentName").value;
  document.getElementById("confirmBox").classList.add("d-none");
}
function confirmNo(){
  document.getElementById("studentName").value="";
  currentName="";
  document.getElementById("confirmBox").classList.add("d-none");
}

// Ambil soal
async function fetchSoal(){
  try{
    const res = await fetch(soalURL);
    if(!res.ok) throw new Error("Gagal mengambil soal");
    soal = await res.json();
  } catch(err){
    alert("Tidak bisa memuat soal: "+err.message);
  }
}

async function loadQuestions(){
  const subject = document.getElementById("subjectSelect").value;
  if(!subject || !currentName){ alert("Isi nama & pilih mapel!"); return; }

  // cek ke Google Sheets apakah nama+mapel sudah digunakan
  try{
    let cek = await fetch(WEB_APP_URL+"?action=cek&nama="+encodeURIComponent(currentName)+"&mapel="+encodeURIComponent(subject));
    let res = await cek.json();
    if(res.status==="used"){
      alert("‚ö†Ô∏è Nama "+currentName+" sudah mengerjakan "+subject+". Hubungi guru untuk reset.");
      return;
    }
  }catch(e){ console.error(e); }

  if(Object.keys(soal).length===0) await fetchSoal();
  if(!soal[subject]){ alert("Soal untuk mapel ini belum tersedia!"); return; }

  const container = document.getElementById("questionContainer");
  container.innerHTML = "";
  soal[subject].forEach((q,i)=>{
    let html = `<div class="question-box" id="qbox${i}"><p><b>${i+1}. ${q.text}</b></p>`;
    if(q.image) html += `<img src="${q.image}" alt="Soal Gambar">`;
    if(q.table) html += q.table;
    html += q.options.map((opt,j)=>
      `<div class="form-check">
        <input class="form-check-input" type="radio" name="q${i}" value="${["a","b","c","d"][j]}">
        <label class="form-check-label">${opt}</label>
      </div>`
    ).join("");
    html += `</div>`;
    container.innerHTML += html;
  });

  document.getElementById("quizForm").classList.remove("d-none");
}

// === CEK & SUBMIT ===
async function submitAnswers(){
  const subject = document.getElementById("subjectSelect").value;
  let unanswered = [];
  
  soal[subject].forEach((q,i)=>{
    let sel = document.querySelector(`input[name="q${i}"]:checked`);
    if(!sel) unanswered.push(i);
  });

  if(unanswered.length > 0){
    document.getElementById("qbox"+unanswered[0]).scrollIntoView({behavior:"smooth", block:"center"});
    alert("‚ö†Ô∏è Masih ada soal yang belum dijawab! Silakan lengkapi terlebih dahulu.");
    return;
  }

  // === Konfirmasi dengan hitung mundur 30 detik ===
  let confirmDiv = document.createElement("div");
  confirmDiv.className = "alert alert-warning mt-3";
  let timeLeft = 30;
  confirmDiv.innerHTML = `
    <p>‚è≥ Apakah kamu yakin ingin mengakhiri ulangan? <b>${timeLeft}</b> detik untuk konfirmasi.</p>
    <button id="btnYes" class="btn btn-danger btn-sm me-2">Ya, saya yakin</button>
    <button id="btnNo" class="btn btn-secondary btn-sm">Tidak, periksa lagi</button>
  `;
  document.getElementById("quizForm").appendChild(confirmDiv);

  let timer = setInterval(()=>{
    timeLeft--;
    confirmDiv.querySelector("b").innerText = timeLeft;
    if(timeLeft <= 0){
      clearInterval(timer);
      confirmDiv.remove();
      alert("‚ùå Waktu konfirmasi habis, silakan tekan Kumpulkan lagi jika ingin mengakhiri.");
    }
  },1000);

  confirmDiv.querySelector("#btnYes").onclick = async ()=>{
    clearInterval(timer);
    confirmDiv.remove();

    // hitung skor
    let score = 0;
    soal[subject].forEach((q,i)=>{
      let sel = document.querySelector(`input[name="q${i}"]:checked`);
      if(sel && sel.value.toLowerCase() === q.answer.toLowerCase()) score += 10;
    });

    document.getElementById("result").classList.remove("d-none");
    document.getElementById("result").innerText = `${currentName} mendapat skor ${score}`;

    // Kirim ke Google Sheets via Web App
    try{
      let res = await fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify({
          action:"submit",
          nama: currentName,
          mapel: subject,
          skor: score,
          tanggal: new Date().toLocaleString()
        }),
        headers: {"Content-Type":"application/json"}
      });
      let out = await res.json();
      if(out.status==="error"){
        alert(out.message);
      } else {
        console.log("Data berhasil dikirim ke Google Sheets");
      }
    } catch(err){
      console.error("Gagal kirim data:", err);
    }
  };

  confirmDiv.querySelector("#btnNo").onclick = ()=>{
    clearInterval(timer);
    confirmDiv.remove();
  };
}
</script>
</body>
</html>
