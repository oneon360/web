<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Nilai Siswa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { background:#f8f9fa; }
    .small-muted { font-size:0.85rem; color:#666; }
  </style>
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="card p-4 shadow">
    <h4>ðŸ“Š Rekap Nilai Ulangan</h4>

    <div id="loginBox" class="mb-3">
      <input type="password" id="adminPass" class="form-control mb-2" placeholder="Password Admin">
      <button class="btn btn-primary" onclick="loginAdmin()">Login</button>
      <div class="small-muted mt-2">Catatan: pastikan Web App Google Apps Script Anda sudah di-deploy sebagai "Anyone, even anonymous".</div>
    </div>

    <div id="rekapPanel" class="d-none">
      <div class="mb-3">
        <button class="btn btn-success" onclick="fetchData()">ðŸ”„ Refresh Data</button>
        <button class="btn btn-primary ms-2" onclick="downloadExcel()">ðŸ“¥ Unduh Excel</button>
      </div>

      <div id="rekapContent"></div>
      <div id="debugLog" class="mt-3 small text-muted"></div>
    </div>
  </div>
</div>

<script>
const ADMIN_PASSWORD = "12345";
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwuERqx4rx2qqRO0xipSENzwqSfMbPbbaBfa6nLBoAAk80VVlvvvmRvjZqo9lDwcJ06eg/exec"; 

let hasil = []; // array data siswa

function loginAdmin(){
  if(document.getElementById("adminPass").value === ADMIN_PASSWORD){
    document.getElementById("loginBox").classList.add("d-none");
    document.getElementById("rekapPanel").classList.remove("d-none");
    fetchData();
  } else {
    alert("Password salah!");
  }
}

function setDebug(msg){
  const el = document.getElementById("debugLog");
  el.textContent = msg;
  console.debug(msg);
}

function normalizeRow(row){
  if(Array.isArray(row)){
    return {nama: row[0]||"", mapel: row[1]||"", skor:Number(row[2])||0, tanggal:row[3]||""};
  }
  if(row && typeof row === "object"){
    const map={}; for(const k of Object.keys(row)){ map[k.toLowerCase().trim()] = row[k]; }
    return {
      nama: map.nama || map.name || map['nama siswa'] || "",
      mapel: map.mapel || map.subject || map.mata_pelajaran || "",
      skor: Number(map.skor || map.score || map.nilai || 0) || 0,
      tanggal: map.tanggal || map.date || map.waktu || ""
    };
  }
  return {nama:"", mapel:"", skor:0, tanggal:""};
}

function toArraySafe(data){
  if (Array.isArray(data)) return data;
  if (!data) return [];
  if (typeof data === "object"){
    const keys = Object.keys(data);
    const allNumeric = keys.length > 0 && keys.every(k => /^\d+$/.test(k));
    if(allNumeric){ return keys.map(k => data[k]); }
    return [data];
  }
  return [];
}

async function fetchData(){
  setDebug("Mengambil data dari server...");
  try {
    const res = await fetch(WEB_APP_URL);
    const text = await res.text();
    let data = JSON.parse(text);
    const arr = toArraySafe(data);
    hasil = arr.map(r => normalizeRow(r));
    if(hasil.length === 0){
      document.getElementById("rekapContent").innerHTML = "<p>Belum ada data siswa.</p>";
      return;
    }
    renderTable();
    setDebug(`Data berhasil dimuat (${hasil.length} baris).`);
  } catch(err){
    console.error(err);
    alert("Gagal mengambil data: " + err.message);
  }
}

function renderTable(){
  const container = document.getElementById("rekapContent");
  container.innerHTML = "";

  const grouped = {};
  hasil.forEach(h => {
    const key = (h.nama || "(Tanpa nama)").toString();
    if(!grouped[key]) grouped[key] = [];
    grouped[key].push(h);
  });

  for(const nama in grouped){
    const rows = grouped[nama];
    let total = 0;
    let count = rows.length;

    let table = `
      <div class="border rounded p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mt-1 mb-2">${nama}</h5>
          <button class="btn btn-sm btn-danger" onclick="resetSiswa('${nama.replace(/'/g,"\\'")}')">ðŸ—‘ Reset ${nama}</button>
        </div>
        <table class="table table-sm table-bordered">
          <thead class="table-light">
            <tr><th>Mapel</th><th>Skor</th><th>Waktu</th></tr>
          </thead>
          <tbody>
    `;
    rows.forEach(r => {
      const skor = Number(r.skor) || 0;
      total += skor;
      table += `<tr><td>${escapeHtml(r.mapel)}</td><td>${escapeHtml(skor)}</td><td>${escapeHtml(r.tanggal)}</td></tr>`;
    });
    const rata = (count===0) ? "0.00" : (total/count).toFixed(2);
    table += `
          </tbody>
        </table>
        <p><strong>Total Skor:</strong> ${total} | <strong>Rata-rata:</strong> ${rata}</p>
      </div>
    `;
    container.innerHTML += table;
  }
}

function escapeHtml(s){
  if(s===null||s===undefined) return "";
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
                  .replaceAll('"',"&quot;").replaceAll("'","&#39;");
}

function downloadExcel(){
  if(hasil.length === 0){ alert("Belum ada data untuk diekspor."); return; }
  const ws = XLSX.utils.json_to_sheet(hasil);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Rekap");
  XLSX.writeFile(wb, "rekap_ulangan.xlsx");
}

/** Reset data siswa di array + database Google Sheet */
async function resetSiswa(nama){
  if(!confirm(`Apakah Anda yakin ingin mereset data untuk ${nama}?`)) return;
  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify({ action:"reset", nama:nama }),
      headers: { "Content-Type":"application/json" }
    });
    const result = await res.json();
    if(result.status === "success"){
      hasil = hasil.filter(h => h.nama !== nama);
      renderTable();
      setDebug(`Data siswa "${nama}" telah dihapus dari database.`);
    } else {
      alert("Gagal reset siswa: " + result.message);
    }
  } catch(err){
    alert("Error reset siswa: " + err.message);
  }
}
</script>
</body>
</html>
