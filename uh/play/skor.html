<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Nilai Siswa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { background:#f8f9fa; }
    .small-muted { font-size:0.85rem; color:#666; }
    td .btn-sm { padding:2px 6px; font-size:0.75rem; }
    .mapel-badge { cursor:pointer; }
  </style>
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="card p-4 shadow">
    <h4>📊 Rekap Nilai Ulangan</h4>

    <!-- Login Admin -->
    <div id="loginBox" class="mb-3">
      <input type="password" id="adminPass" class="form-control mb-2" placeholder="Password Admin">
      <button class="btn btn-primary" onclick="loginAdmin()">Login</button>
      <div class="small-muted mt-2">Catatan: pastikan Web App Google Apps Script Anda sudah di-deploy sebagai "Anyone, even anonymous".</div>
    </div>

    <!-- Panel Rekap -->
    <div id="rekapPanel" class="d-none">
      <div class="mb-3">
        <button class="btn btn-success" onclick="fetchData()">🔄 Refresh Data</button>
        <button class="btn btn-primary ms-2" onclick="downloadExcel()">📥 Unduh Excel</button>
      </div>

      <div id="rekapContent"></div>

      <h5 class="mt-4">⚙️ Pengaturan Mapel Aktif</h5>
      <div id="mapelContent" class="mb-3"></div>

      <div id="debugLog" class="mt-3 small text-muted"></div>
    </div>
  </div>
</div>

<script>
const ADMIN_PASSWORD = "12345"; // ganti sesuai kebutuhan
const WEB_APP_URL = "https://cors.ssss.fun/https://script.google.com/macros/s/AKfycby52Cz1GFVAlQOH0PsTGaK09eCrv1dS8kkxdWaQD9F2kdDwTUNuLfrePEeybXp55gef/exec"; // ganti dengan URL WebApp Anda

let hasil = [];
let mapelAktif = [];

/* ---------------- Login ---------------- */
function loginAdmin(){
  if(document.getElementById("adminPass").value === ADMIN_PASSWORD){
    document.getElementById("loginBox").classList.add("d-none");
    document.getElementById("rekapPanel").classList.remove("d-none");
    fetchData();
    fetchMapel();
  } else {
    alert("Password salah!");
  }
}

function setDebug(msg){
  document.getElementById("debugLog").textContent = msg;
  console.debug(msg);
}

/* ---------------- Helper ---------------- */
function normalizeRow(row){
  if(Array.isArray(row)){
    return {nama: row[0]||"", mapel: row[1]||"", skor:Number(row[2])||0, tanggal:row[3]||""};
  }
  if(row && typeof row === "object"){
    const map={}; for(const k of Object.keys(row)){ map[k.toLowerCase().trim()] = row[k]; }
    return {
      nama: map.nama || "",
      mapel: map.mapel || "",
      skor: Number(map.skor||0) || 0,
      tanggal: map.tanggal || ""
    };
  }
  return {nama:"", mapel:"", skor:0, tanggal:""};
}

function toArraySafe(data){
  if (Array.isArray(data)) return data;
  if (!data) return [];
  if (typeof data === "object"){
    const keys = Object.keys(data);
    const allNumeric = keys.length>0 && keys.every(k=>/^\d+$/.test(k));
    if(allNumeric) return keys.map(k=>data[k]);
    return [data];
  }
  return [];
}

/* ---------------- Fetch Rekap ---------------- */
async function fetchData(){
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();

    if(data.status==="error"){
      setDebug("Error dari server: "+data.message);
      return;
    }

    hasil = toArraySafe(data).map(r => normalizeRow(r));
    renderTable();
    setDebug(`Data berhasil dimuat (${hasil.length} baris).`);
  } catch(err){
    alert("Gagal ambil data: " + err.message);
    setDebug("Fetch error: " + err.message);
  }
}

function renderTable(){
  const container = document.getElementById("rekapContent");
  container.innerHTML = "";

  const grouped = {};
  hasil.forEach(h => {
    const key = h.nama || "(Tanpa nama)";
    if(!grouped[key]) grouped[key] = [];
    grouped[key].push(h);
  });

  for(const nama in grouped){
    const rows = grouped[nama];
    let total=0;
    let count=rows.length;

    let table = `
      <div class="border rounded p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mt-1 mb-2">${nama}</h5>
          <button class="btn btn-sm btn-danger" onclick="resetSiswa('${nama.replace(/'/g,"\\'")}')">🗑 Reset Semua</button>
        </div>
        <table class="table table-sm table-bordered">
          <thead class="table-light">
            <tr><th>Mapel</th><th>Skor</th><th>Waktu</th><th>Aksi</th></tr>
          </thead>
          <tbody>
    `;

    rows.forEach(r => {
      total += r.skor;
      table += `<tr>
        <td>${escapeHtml(r.mapel)}</td>
        <td>${r.skor}</td>
        <td>${escapeHtml(r.tanggal)}</td>
        <td><button class="btn btn-sm btn-warning" onclick="resetMapel('${nama.replace(/'/g,"\\'")}','${escapeHtml(r.mapel)}')">Reset Mapel</button></td>
      </tr>`;
    });

    const rata = (count===0) ? "0.00" : (total/count).toFixed(2);
    table += `
          </tbody>
        </table>
        <p><strong>Total Skor:</strong> ${total} | <strong>Rata-rata:</strong> ${rata}</p>
      </div>
    `;
    container.innerHTML += table;
  }
}

function escapeHtml(s){
  if(!s) return "";
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
}

function downloadExcel(){
  if(hasil.length===0){ alert("Belum ada data."); return; }
  const ws = XLSX.utils.json_to_sheet(hasil);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Rekap");
  XLSX.writeFile(wb, "rekap_ulangan.xlsx");
}

/* ---------------- Reset Data ---------------- */
async function resetSiswa(nama){
  if(!confirm(`Yakin reset semua data ${nama}?`)) return;
  try {
    const res = await fetch(WEB_APP_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({action:"resetSiswa", nama:nama})
    });
    const result = await res.json();
    if(result.status==="success"){
      hasil = hasil.filter(h => h.nama!==nama);
      renderTable();
      setDebug(result.message);
    } else alert("Gagal: "+result.message);
  } catch(err){ alert(err.message); }
}

async function resetMapel(nama,mapel){
  if(!confirm(`Yakin reset mapel ${mapel} untuk ${nama}?`)) return;
  try {
    const res = await fetch(WEB_APP_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({action:"resetMapel", nama:nama, mapel:mapel})
    });
    const result = await res.json();
    if(result.status==="success"){
      hasil = hasil.filter(h => !(h.nama===nama && h.mapel===mapel));
      renderTable();
      setDebug(result.message);
    } else alert("Gagal: "+result.message);
  } catch(err){ alert(err.message); }
}

/* ---------------- Pengaturan Mapel Aktif ---------------- */
async function fetchMapel(){
  try{
    const res = await fetch(WEB_APP_URL+"?action=mapel");
    const json = await res.json();
    if(json.status==="success"){
      mapelAktif = Array.isArray(json.aktif) ? json.aktif : [];
      renderMapel();
    }
  }catch(e){ console.error(e); }
}

function renderMapel(){
  const container = document.getElementById("mapelContent");
  container.innerHTML = "";
  const semuaMapel = ["Pendidikan Pancasila","Bahasa Indonesia","Matematika","IPAS","Seni Rupa"];

  semuaMapel.forEach(m=>{
    const aktif = mapelAktif.includes(m);
    container.innerHTML += `
      <span class="badge rounded-pill ${aktif?'bg-success':'bg-secondary'} mapel-badge me-2 mb-2"
        onclick="toggleMapel('${m}')">${m} (${aktif?'ON':'OFF'})</span>
    `;
  });
}

async function toggleMapel(mapel){
  const aktif = mapelAktif.includes(mapel) ? false : true;
  try{
    const res = await fetch(WEB_APP_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        action:"updateMapel",
        mapel:[{nama:mapel, aktif:aktif}]
      })
    });
    const result = await res.json();
    if(result.status==="success"){
      if(aktif){
        if(!mapelAktif.includes(mapel)) mapelAktif.push(mapel);
      }else{
        mapelAktif = mapelAktif.filter(m=>m!==mapel);
      }
      renderMapel();
      setDebug(result.message);
    }else alert("Gagal: "+result.message);
  }catch(err){ alert(err.message); }
}
</script>
</body>
</html>
