<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Nilai Siswa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="card p-4 shadow">
    <h4>üìä Rekap Nilai Ulangan</h4>
    <div id="loginBox">
      <input type="password" id="adminPass" class="form-control mb-2" placeholder="Password Admin">
      <button class="btn btn-primary" onclick="loginAdmin()">Login</button>
    </div>
    <div id="rekapPanel" class="d-none">
      <div id="rekapContent"></div>
      <button class="btn btn-success mt-3" onclick="downloadExcel()">üì• Unduh Excel</button>
    </div>
  </div>
</div>
<script>
const ADMIN_PASSWORD = "12345";

// Ambil data dari localStorage (array hasil per ulangan siswa)
let hasil = JSON.parse(localStorage.getItem("hasilSiswa")) || [];

// Fungsi login admin
function loginAdmin(){
  if(document.getElementById("adminPass").value === ADMIN_PASSWORD){
    document.getElementById("loginBox").classList.add("d-none");
    document.getElementById("rekapPanel").classList.remove("d-none");
    renderTable();
  } else {
    alert("Password salah!");
  }
}

// Fungsi render tabel dengan grouping per siswa
function renderTable(){
  const container = document.getElementById("rekapContent");
  container.innerHTML = "";

  // Kelompokkan berdasarkan nama
  const grouped = {};
  hasil.forEach(h => {
    if(!grouped[h.nama]) grouped[h.nama] = [];
    grouped[h.nama].push(h);
  });

  // Buat tabel untuk tiap siswa
  for(const nama in grouped){
    let total = 0;
    let count = grouped[nama].length;

    let table = `
      <h5 class="mt-3">${nama}</h5>
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr><th>Mapel</th><th>Skor</th><th>Waktu</th></tr>
        </thead>
        <tbody>
    `;

    grouped[nama].forEach(h => {
      total += h.skor;
      table += `<tr><td>${h.mapel}</td><td>${h.skor}</td><td>${h.tanggal}</td></tr>`;
    });

    let rata = (total / count).toFixed(2);

    table += `
        </tbody>
      </table>
      <p><strong>Total Skor:</strong> ${total} &nbsp; | &nbsp; <strong>Rata-rata:</strong> ${rata}</p>
      <button class="btn btn-sm btn-danger mb-4" onclick="hapusSiswa('${nama}')">‚ùå Hapus Data ${nama}</button>
    `;

    container.innerHTML += table;
  }
}

// Fungsi hapus semua hasil ulangan per siswa
function hapusSiswa(nama){
  if(confirm("Yakin ingin menghapus semua data milik " + nama + " ?")){
    hasil = hasil.filter(h => h.nama !== nama);
    localStorage.setItem("hasilSiswa", JSON.stringify(hasil));
    renderTable();
  }
}

// Fungsi unduh Excel
function downloadExcel(){
  const ws = XLSX.utils.json_to_sheet(hasil);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Rekap");
  XLSX.writeFile(wb, "rekap_ulangan.xlsx");
}
</script>
</body>
</html>
