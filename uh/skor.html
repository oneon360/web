<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Nilai Siswa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="card p-4 shadow">
    <h4>ðŸ“Š Rekap Nilai Ulangan</h4>
    <div id="loginBox">
      <input type="password" id="adminPass" class="form-control mb-2" placeholder="Password Admin">
      <button class="btn btn-primary" onclick="loginAdmin()">Login</button>
    </div>
    <div id="rekapPanel" class="d-none">
      <button class="btn btn-success mb-3" onclick="fetchData()">ðŸ”„ Refresh Data</button>
      <div id="rekapContent"></div>
      <button class="btn btn-primary mt-3" onclick="downloadExcel()">ðŸ“¥ Unduh Excel</button>
    </div>
  </div>
</div>

<script>
const ADMIN_PASSWORD = "12345";  
const WEB_APP_URL = "https://script.google.com/a/macros/guru.sd.belajar.id/s/AKfycbwpHJY63zAtFdSG85xKH8eRTfk4RC8JLSzOaSmqvl50dOFllomVgYHSaikxSu1kJew/exec"; // ganti dengan URL Web App Anda

let hasil = []; // akan diisi dari Google Sheets

// Login admin
function loginAdmin(){
  if(document.getElementById("adminPass").value === ADMIN_PASSWORD){
    document.getElementById("loginBox").classList.add("d-none");
    document.getElementById("rekapPanel").classList.remove("d-none");
    fetchData();
  } else {
    alert("Password salah!");
  }
}

// Ambil data dari Google Sheets
async function fetchData(){
  try {
    const res = await fetch(WEB_APP_URL);
    hasil = await res.json();  // hasil berupa array objek {nama, mapel, skor, tanggal}
    renderTable();
  } catch(err){
    alert("Gagal mengambil data: " + err.message);
  }
}

// Render tabel dengan grouping per siswa
function renderTable(){
  const container = document.getElementById("rekapContent");
  container.innerHTML = "";

  if(hasil.length === 0){
    container.innerHTML = "<p>Belum ada data siswa.</p>";
    return;
  }

  const grouped = {};
  hasil.forEach(h => {
    if(!grouped[h.nama]) grouped[h.nama] = [];
    grouped[h.nama].push(h);
  });

  for(const nama in grouped){
    let total = 0;
    let count = grouped[nama].length;

    let table = `
      <h5 class="mt-3">${nama}</h5>
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr><th>Mapel</th><th>Skor</th><th>Waktu</th></tr>
        </thead>
        <tbody>
    `;

    grouped[nama].forEach(h => {
      total += parseInt(h.skor);
      table += `<tr><td>${h.mapel}</td><td>${h.skor}</td><td>${h.tanggal}</td></tr>`;
    });

    let rata = (total / count).toFixed(2);

    table += `
        </tbody>
      </table>
      <p><strong>Total Skor:</strong> ${total} &nbsp; | &nbsp; <strong>Rata-rata:</strong> ${rata}</p>
    `;

    container.innerHTML += table;
  }
}

// Export ke Excel
function downloadExcel(){
  if(hasil.length === 0){
    alert("Belum ada data untuk diekspor.");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(hasil);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Rekap");
  XLSX.writeFile(wb, "rekap_ulangan.xlsx");
}
</script>
</body>
</html>
