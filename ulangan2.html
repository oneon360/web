<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SDN 1 KANDANGAN KOTA</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>

.kop { text-align:center; margin-bottom:25px; border-bottom:3px double #000; padding-bottom:10px;}
.kop img{width:80px;height:80px;margin-bottom:10px;}
.kop h2,p{margin:0;line-height:1.4;}
.text-center{margin-bottom: 4px;}
.text-center h4{margin-bottom: 0px;}
.text-center p{margin-bottom: 6px;}
.question-box{padding:15px;border:1px solid #ddd;border-radius:8px;margin-bottom:15px;background:#fff;}
img{max-width:100%;height:auto;display:block;margin:10px auto;max-height:300px;object-fit:contain;}
.mapel-disabled { color:#999; font-style:italic; }

/* wadah gelembung */
.bubble-container {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none; /* supaya tidak mengganggu klik */
  z-index: 0;           /* di belakang semua konten */
  overflow: hidden;
}

/* gaya gelembung */
.bubble {
  position: absolute;
  bottom: -50px;
  background: rgba(173, 216, 230, 0.6); /* biru muda transparan */
  border-radius: 50%;
  opacity: 0.7;
  animation: rise 10s linear infinite;
}

@keyframes rise {
  0% {
    transform: translateY(0) scale(1);
    opacity: 0.7;
  }
  100% {
    transform: translateY(-110vh) scale(0.5);
    opacity: 0;
  }

</style>
</head>
<body class="bg-light">
<div class="container py-4">
<div class="bubble-container"></div>

  <div class="kop">
    <img src="https://oneon360.github.io/web/uh/logo-sdn1kk-wartatrans.png" alt="Logo Sekolah">
    <h2>SDN 1 KANDANGAN KOTA</h2>
    <p>Jl. Jendral Achmad Yani, Kecamatan Kandangan</p>
    <p>NISN: 30301968</p>
  </div>

  <div class="text-center">
    <h4>PENILAIAN HARIAN KELAS 6/B</h4>
    <p>Tahun Pelajaran 2025</p>
  </div>

  <!-- Petunjuk pengerjaan -->
  <div class="alert alert-warning">
    <h5>üìå Petunjuk Pengerjaan:</h5>
    <ul>
      <li>Pilih nama lengkap sebelum mulai.</li>
      <li>Pilih mata pelajaran yang aktif untuk dikerjakan.</li>
      <li>Masukkan token ujian yang diberikan guru.</li>
      <li>Kerjakan soal ulangan sesuai waktu yang ditentukan.</li>
      <li>Pilih dan beri tanda jawaban yang benar dengan menekan check box dibawah setiap soal.</li>
      <li>Kerjakan ulangan dengan jujur.</li>
      <li>Ulangan hanya bisa dikerjakan <b>1 kali</b>.</li>
    </ul>
  </div>

  <div class="card p-4 shadow">
    <h5>üìù Data Peserta Ulangan</h5>
    <div class="mb-3">
      <label>Nama Peserta</label>
      <select id="studentName" class="form-select">
        <option value="">-- Pilih Nama --</option>
      </select>
    </div>
    <div id="confirmBox" class="alert alert-info d-none">
      Apakah benar nama kamu <b><span id="confirmName"></span></b>? 
      <button class="btn btn-success btn-sm" onclick="confirmYes()">Ya</button>
      <button class="btn btn-danger btn-sm" onclick="confirmNo()">Tidak</button>
    </div>
    <div class="mb-3">
      <label>Mata Pelajaran</label>
      <select id="subjectSelect" class="form-select">
        <option value="">-- Pilih Pelajaran --</option>
      </select>
    </div>

    <!-- Tambahan input token -->
<div class="input-group mb-3">
  <input type="password" id="tokenInput" class="form-control" placeholder="Masukkan token ulangan">
  <button class="btn btn-outline-secondary" type="button" id="toggleToken">
    üëÅ
  </button>
</div>

    <button class="btn btn-primary mb-3" id="btnStart">Mulai</button>

    <!-- info header soal -->
    <div id="quizInfo" class="alert alert-info d-none"></div>

    <form id="quizForm" class="d-none">
    <div id="passageContainer" class="alert alert-secondary d-none"></div>
      <div id="questionContainer"></div>
      <button type="button" class="btn btn-success mt-3" id="btnSubmit">Kumpulkan Jawaban</button>
    </form>

    <div id="result" class="alert alert-info mt-3 d-none"></div>
  </div>
</div>
<!-- Modal Hasil -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center shadow-lg border-0">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title w-100 fw-bold text-uppercase" 
    id="resultModalLabel" 
    style="font-size: 2.3rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">
  üéâ Selamat!
</h5>

      </div>
      <div class="modal-body">
        <h4 id="modalNama" class="fw-bold mb-2"></h4>
        <p>Kamu telah menyelesaikan ulangan <b id="modalMapel"></b>.</p>

        <h3 class="fw-bold text-success mb-3">
          Hasil perolehan nilai: <span id="modalSkor">0</span>
        </h3>

        <div class="fs-5">
          ‚úÖ Benar: <span id="modalBenar">0</span> &nbsp;&nbsp;
          ‚ùå Salah: <span id="modalSalah">0</span>
        </div>

        <p class="mt-3 text-muted">Semangat belajar dan tingkatkan prestasi</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Kembali ke Halaman Awal</button>
      </div>
    </div>
  </div>
</div>

<!-- Efek salju -->
<canvas id="snow" style="
 position:fixed;
 top:0;left:0;width:100%;height:100%;
 pointer-events:none; /* agar tidak menghalangi klik */
 z-index:0; /* di belakang soal */
"></canvas>

<script>
let soal = {};
let currentName = "";
let currentSubject = "";
const soalURL = "https://oneon360.github.io/web/soal/ulangan2.json";
const siswaURL = "https://oneon360.github.io/web/uh/play/nama.json";
const WEB_APP_URL = "https://cors.ssss.fun/https://script.google.com/macros/s/AKfycbyh4wdcw1iJFqs3bymVrSwTCLCUpvvg00bsA-zA23pVnq5-KwYUN1hrzvWL06HVE3Qp/exec";

const ALL_MAPEL = ["Pendidikan Pancasila","Bahasa Indonesia","Matematika","IPAS","Seni Rupa"];
let aktifMapel = [];
let timerInterval;

// === FETCH SISWA DAN MAPEL ===
async function fetchSiswa(){
  try{
    const res = await fetch(siswaURL);
    const data = await res.json();
    const sel = document.getElementById("studentName");
    sel.innerHTML = `<option value="">-- Pilih Nama --</option>`;
    data.forEach(s=>{
      let opt = document.createElement("option");
      opt.value = s.nama;
      opt.textContent = s.nama;
      sel.appendChild(opt);
    });
  }catch(e){ console.error(e); }
}
fetchSiswa();

async function fetchMapel(){
  try {
    const res = await fetch(WEB_APP_URL+"?action=mapel");
    const json = await res.json();
    if(json.status==="success"){
      aktifMapel = Array.isArray(json.data) ? json.data : [];
      renderMapelOptions();
    }
  } catch(err){ console.error("Fetch mapel error:", err); }
}
fetchMapel();
setInterval(fetchMapel, 30000);

function renderMapelOptions(){
  const sel = document.getElementById("subjectSelect");
  sel.innerHTML = "<option value=''>-- Pilih Pelajaran --</option>";
  ALL_MAPEL.forEach(m=>{
    let opt = document.createElement("option");
    opt.value = m;
    opt.textContent = aktifMapel.includes(m) ? m : m + " (tidak tersedia)";
    if(!aktifMapel.includes(m)){
      opt.disabled = true;
      opt.classList.add("mapel-disabled");
    }
    sel.appendChild(opt);
  });
}

// === KONFIRMASI NAMA ===
document.getElementById("studentName").addEventListener("change", ()=>{
  const val = document.getElementById("studentName").value;
  const box = document.getElementById("confirmBox");
  if(val){
    document.getElementById("confirmName").innerText = val;
    box.classList.remove("d-none");
  } else box.classList.add("d-none");
});
function confirmYes(){ currentName = document.getElementById("studentName").value; document.getElementById("confirmBox").classList.add("d-none"); }
function confirmNo(){ document.getElementById("studentName").value=""; currentName=""; document.getElementById("confirmBox").classList.add("d-none"); }

// === AMBIL SOAL ===
async function fetchSoal(){ const res = await fetch(soalURL); soal = await res.json(); }

// === CEK TOKEN ===
async function cekToken(token){
  const res = await fetch(WEB_APP_URL,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body: JSON.stringify({action:"cekToken", token})
  });
  const data = await res.json();
  return data.status === "valid";
}

// === MULAI ULANGAN ===
async function loadQuestions(){
  const subject = document.getElementById("subjectSelect").value;
  const token = document.getElementById("tokenInput").value.trim();
  if(!subject || !currentName){ alert("Isi nama peserta & pilih mata pelajaran!"); return; }
  if(!token){ alert("Masukkan token ujian terlebih dahulu!"); return; }

  const valid = await cekToken(token);
  if(!valid){ alert("Token ujian tidak valid. Hubungi guru."); return; }

  currentSubject = subject;

  try{
    const cek = await fetch(WEB_APP_URL,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body: JSON.stringify({action:"cek", nama:currentName, mapel:subject})
    });
    const res = await cek.json();
    if(res.status==="success" && res.data.sudah){
      alert("‚ö†Ô∏è "+currentName+" sudah mengerjakan "+subject+".");
      return;
    }
  }catch(e){ console.error("Cek gagal:", e); }

  if(Object.keys(soal).length===0) await fetchSoal();
  if(!soal[subject]){ alert("Soal belum tersedia!"); return; }

// Tampilkan info ulangan
const infoBox = document.getElementById("quizInfo");
const totalSoal = soal[subject].length;

// Hitung total waktu (2 menit 30 detik per soal)
const waktuPerSoal = 2 * 60 + 30; // 150 detik
const totalWaktu = totalSoal * waktuPerSoal; // detik total

const menit = Math.floor(totalWaktu / 60);
const detik = totalWaktu % 60;

infoBox.classList.remove("d-none");
infoBox.innerHTML = `
  <h5>üìö Mata Pelajaran: <b>${subject}</b></h5>
  <p>Jumlah Soal: <b>${totalSoal}</b></p>
  <p>Sisa Waktu: <b id="timer">${String(menit).padStart(2,"0")}:${String(detik).padStart(2,"0")}</b></p>
`;

startTimer(totalWaktu); // Jalankan timer otomatis sesuai jumlah soal


  const container = document.getElementById("questionContainer");
  const passageDiv = document.getElementById("passageContainer");
  if (soal[subject][0].passage) {
    passageDiv.classList.remove("d-none");
    passageDiv.innerHTML = `<h5>Bacalah teks berikut ini!</h5><p>${soal[subject][0].passage}</p>`;
  } else { passageDiv.classList.add("d-none"); passageDiv.innerHTML = ""; }

  container.innerHTML = "";
  soal[subject].forEach((q,i)=>{
    let html = `<div class="question-box" id="qbox${i}">`;
    if(q.image) html += `<img src="${q.image}" alt="Soal">`;
    if(q.table) html += `<div>${q.table}</div>`;
    if(q.narasi) html += `<div>${q.narasi}</div>`;
    html += `<p><b>${q.text}</b></p>`;
    html += q.options.map((opt,j)=>`
      <div class="form-check">
        <input class="form-check-input" type="radio" name="q${i}" value="${["a","b","c","d"][j]}">
        <label class="form-check-label">${opt}</label>
      </div>`).join("");
    html += `</div>`;
    container.innerHTML += html;
  });

  document.getElementById("quizForm").classList.remove("d-none");
}

// === TIMER ===
function startTimer(duration){
  clearInterval(timerInterval);
  let time = duration;
  timerInterval = setInterval(()=>{
    const m = Math.floor(time/60), s = time%60;
    document.getElementById("timer").textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    if(time<=0){ clearInterval(timerInterval); alert("‚è∞ Waktu habis!"); submitAnswers(); }
    time--;
  },1000);
}

// === SUBMIT JAWABAN ===
async function submitAnswers(){
  const btn = document.getElementById("btnSubmit");
  btn.disabled = true;

  let jawabanSiswa=[], correctAnswers=[], skorBenar=0;
  soal[currentSubject].forEach((q,i)=>{
    const sel = document.querySelector(`input[name="q${i}"]:checked`);
    const jawaban = sel ? sel.value : "";
    jawabanSiswa.push(jawaban);
    correctAnswers.push(q.answer);
    if(jawaban.toLowerCase()===q.answer.toLowerCase()) skorBenar++;
  });

  const totalSoal = soal[currentSubject].length;
  const skorSalah = totalSoal - skorBenar;
  const skorTotal = Math.round((skorBenar/totalSoal)*100);
  const timestamp = new Date().toLocaleString();

  // Simpan data
  try{
    await fetch(WEB_APP_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"submit",nama:currentName,mapel:currentSubject,skor:skorTotal,tanggal:timestamp})});
    await fetch(WEB_APP_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"submitJawaban",nama:currentName,mapel:currentSubject,jawaban:jawabanSiswa,correctAnswers,skorBenar,skorSalah,timestamp})});
  }catch(e){console.error(e);}

  clearInterval(timerInterval);

  // === TAMPILKAN MODAL HASIL ===
  document.getElementById("modalNama").textContent = currentName;
  document.getElementById("modalMapel").textContent = currentSubject;
  document.getElementById("modalSkor").textContent = skorTotal;
  document.getElementById("modalBenar").textContent = skorBenar;
  document.getElementById("modalSalah").textContent = skorSalah;

  const modal = new bootstrap.Modal(document.getElementById('resultModal'));
  modal.show();
  startConfetti();

  document.getElementById('resultModal').addEventListener('hidden.bs.modal', ()=>{
    stopConfetti();
    window.location.reload();
  });
}

// === VALIDASI SUBMIT ===
document.getElementById("btnSubmit").addEventListener("click", function(){
  const btn = this;
  if(!currentSubject){ alert("Mapel belum dipilih!"); return; }

  let unanswered = [];
  soal[currentSubject].forEach((q,i)=>{
    if(!document.querySelector(`input[name="q${i}"]:checked`)) unanswered.push(i);
  });

  if(unanswered.length>0){
    unanswered.forEach(idx=>{
      const box = document.getElementById("qbox"+idx);
      box.style.border = "2px solid red";
      setTimeout(()=>{ box.style.border = "1px solid #ddd"; }, 2000);
    });
    document.getElementById("qbox"+unanswered[0]).scrollIntoView({behavior:"smooth", block:"center"});
    alert("‚ö†Ô∏è Masih ada soal yang belum dijawab!");
    return;
  }

  let oldConfirm = document.getElementById("confirmBoxSubmit");
  if(oldConfirm) oldConfirm.remove();

  let confirmDiv = document.createElement("div");
  confirmDiv.id = "confirmBoxSubmit";
  confirmDiv.className = "alert alert-warning mt-3";
  confirmDiv.innerHTML = `
    <p>‚è≥ Apakah kamu yakin ingin mengakhiri ulangan? <b id="confirmTimer">30</b> detik untuk konfirmasi.</p>
    <button type="button" id="btnYes" class="btn btn-danger btn-sm me-2">Ya, saya yakin</button>
    <button type="button" id="btnNo" class="btn btn-secondary btn-sm">Tidak, periksa lagi</button>
  `;
  document.getElementById("quizForm").appendChild(confirmDiv);

  let timeLeft = 30;
  btn.disabled = true;

  let timer = setInterval(()=>{
    timeLeft--;
    const timerEl = document.getElementById("confirmTimer");
    if(timerEl) timerEl.innerText = timeLeft;
    if(timeLeft<=0){
      clearInterval(timer);
      confirmDiv.remove();
      btn.disabled = false;
    }
  },1000);

  confirmDiv.querySelector("#btnNo").addEventListener("click", ()=>{
    clearInterval(timer);
    confirmDiv.remove();
    btn.disabled = false;
  });

  confirmDiv.querySelector("#btnYes").addEventListener("click", async ()=>{
    clearInterval(timer);
    confirmDiv.remove();
    await submitAnswers();
  });
});


// === TOGGLE TOKEN ===
document.getElementById("toggleToken").addEventListener("click",()=>{
  const el=document.getElementById("tokenInput");
  if(el.type==="password"){ el.type="text"; toggleToken.textContent="üé≠"; }
  else { el.type="password"; toggleToken.textContent="üëÅ"; }
});

// === MULAI ===
document.getElementById("btnStart").addEventListener("click",loadQuestions);

// === KONFETI BINTANG ===
let confettiInterval;
function startConfetti(){
  const container=document.createElement("div");
  container.id="confetti-container";
  Object.assign(container.style,{
    position:"fixed",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"hidden",zIndex:1056
  });
  document.body.appendChild(container);
  confettiInterval=setInterval(()=>{
    const star=document.createElement("div");
    star.textContent="‚≠ê";
    Object.assign(star.style,{
      position:"absolute",
      left:Math.random()*100+"%",
      top:"-10px",
      fontSize:(Math.random()*20+10)+"px",
      color:["#FFD700","#FF69B4","#00BFFF","#32CD32","#FF4500"][Math.floor(Math.random()*5)],
      transition:"transform 3s linear, opacity 3s"
    });
    container.appendChild(star);
    setTimeout(()=>{star.style.transform=`translateY(${window.innerHeight+50}px) rotate(${Math.random()*720}deg)`;star.style.opacity=0;},50);
    setTimeout(()=>star.remove(),3000);
  },100);
}
function stopConfetti(){clearInterval(confettiInterval);const c=document.getElementById("confetti-container");if(c) c.remove();}

// === EFEK SALJU (versi lambat & halus) ===
const canvas = document.getElementById("snow");
const ctx = canvas.getContext("2d");
let snowflakes = [];

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

function createSnowflake() {
  return {
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    r: Math.random() * 2 + 1,     // ukuran salju kecil agar lembut
    d: Math.random() * 0.5 + 0.2  // densitas lebih rendah (lebih lambat)
  };
}

for (let i = 0; i < 80; i++) snowflakes.push(createSnowflake());

function drawSnow() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "rgba(180, 220, 255, 0.9)";
  ctx.beginPath();
  for (let flake of snowflakes) {
    ctx.moveTo(flake.x, flake.y);
    ctx.arc(flake.x, flake.y, flake.r, 0, Math.PI * 2);
  }
  ctx.fill();
  updateSnow();
  requestAnimationFrame(drawSnow);
}

function updateSnow() {
  for (let flake of snowflakes) {
    flake.y += flake.d * 0.5;       // üîπ lebih lambat dari sebelumnya
    flake.x += Math.sin(flake.y * 0.01) * 0.3; // sedikit goyangan lembut

    // reset posisi jika salju jatuh ke bawah layar
    if (flake.y > canvas.height) {
      flake.x = Math.random() * canvas.width;
      flake.y = 0;
    }
  }
}

drawSnow();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
